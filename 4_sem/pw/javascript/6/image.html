<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<style>
			table#game > tbody > tr > td {
				text-align: center;
				color: rgba(0, 0, 0, 0);
			}
			table#game.show-cell-numbers > tbody > tr > td {
				text-align: center;
				color: rgba(0, 0, 0, 1);
			}
		</style>
	</head>
	<body>
		<table id="game">
			<tbody></tbody>
		</table>
		<input type="button" value="show/hide cell numbers" onclick="toggleShowCellNumbers()">
		<br>
		<label for="game-n">n</label>
		<input type="number" id="game-n" value="4">
		<br>
		<label for="game-image">image</label>
		<input type="file" id="game-image">
		<br>
		<input type="button" onclick="buttonCreateTable()" value="create table">
	</body>
	<script>
		class Game {
			constructor() {
				this.__n = null;
			}

			createTable(n, imageFile) {
				this.__n = n;
				
				let tableBody = document.querySelector("table#game > tbody");

				Array.prototype.slice.call(tableBody.children)
					.forEach(child => tableBody.removeChild(child));

				let fileReader = new FileReader();
				fileReader.readAsDataURL(imageFile);
				fileReader.onload = () => {
					let imageUrl = fileReader.result;
					imageUrl = `url("${imageUrl}")`;
				
					// create
					let index = 0;
					for (let i = 0; i < this.__n; ++i) {
						let tableRow = document.createElement("tr");
						for (let j = 0; j < this.__n; ++j) {
							let tableData = document.createElement("td");
							if (index != this.__n*this.__n-1) {
								tableData.innerText = (index+1).toString();
					
								tableData.style.width = "50px";
								tableData.style.height = "50px";
								tableData.style.backgroundSize = `${100*n}%`;
								tableData.style.backgroundPosition = `${-100*j}% ${-100*i}%`;
								tableData.style.backgroundImage = imageUrl;
							} else {
								tableData.id = "empty";
							}
							tableRow.appendChild(tableData);

							index += 1;
						}
						tableBody.appendChild(tableRow);
					}

					// shuffle
					for (let i = 0; i < this.__n*this.__n*4; ++i) {
						let direction = Math.floor(Math.random() * 4);
						switch (direction) {
							case 0: this.shift("up");    break;
							case 1: this.shift("down");  break;
							case 2: this.shift("left");  break;
							case 3: this.shift("right"); break;
						}
					}
				};
			}

			shift(direction) {
				let tableDataEmpty = document.getElementById("empty");
				let position = getTableDataPosition(tableDataEmpty);

				let positionDelta = null;
				switch (direction) {
					case "up"   : positionDelta = [ 0 ,  1]; break;
					case "down" : positionDelta = [ 0 , -1]; break;
					case "left" : positionDelta = [ 1 ,  0]; break;
					case "right": positionDelta = [-1 ,  0]; break;
				}

				let newPosition = [
					position[0] + positionDelta[0],
					position[1] + positionDelta[1]
				];

				if (newPosition[0] < 0 || newPosition[0] >= this.__n || newPosition[1] < 0 || newPosition[1] >= this.__n) {
					return;
				}

				let tableDataNew = tableDataFromPosition(newPosition);

				let aux = document.createElement("div");
				tableDataEmpty.replaceWith(aux);
				tableDataNew.replaceWith(tableDataEmpty);
				aux.replaceWith(tableDataNew);
			}
		}

		var game = new Game();
		
		function buttonCreateTable() {
			let nElement = document.getElementById("game-n");
			let imageFileElement = document.getElementById("game-image");

			n = parseInt(nElement.value);
			imageFile = imageFileElement.files[0];

			game.createTable(n, imageFile);
		}
	
		function tableDataFromPosition(position) {
			let tableBody = document.querySelector("table#game > tbody");
			return tableBody.children[position[1]].children[position[0]];
		}

		function getTableDataPosition(tableData) {
			let tableRow = tableData.parentElement;
			let tableBody = tableRow.parentElement;

			let x = Array.prototype.slice.call(tableRow.children)
				.indexOf(tableData);
			let y = Array.prototype.slice.call(tableBody.children)
				.indexOf(tableRow);

			return [x, y];
		}

		document.addEventListener(
			"keydown",
			(event) => {
				switch (event.key) {
					case "ArrowUp"   : game.shift("up");    break;
					case "ArrowDown" : game.shift("down");  break;
					case "ArrowLeft" : game.shift("left");  break;
					case "ArrowRight": game.shift("right"); break;
				}
			}
		)

		function toggleShowCellNumbers() {
			let game = document.getElementById("game");
			if (game.classList.contains("show-cell-numbers")) {
				game.classList.remove("show-cell-numbers");
			} else {
				game.classList.add("show-cell-numbers");
			}
		}
	</script>
</html>
